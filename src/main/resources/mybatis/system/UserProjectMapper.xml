<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jsumt.mapper.system.UserProjectMapper">
	<resultMap type="com.jsumt.vo.system.UserBean" id="userManger">
		<id property="user_id" column="USER_ID" />
		<result property="birthday" column="BIRTHDAY" />
		<result property="user_name" column="USER_NAME" />
		<result property="user_code" column="USER_CODE" />
		<result property="phone" column="PHONE" />
		<result property="work_no" column="WORK_NO" />
		<result property="sex" column="SEX" />
		<result property="work_date" column="WORK_DATE" />
		<result property="link_user_phone" column="LINK_USER_PHONE" />
		<result property="home_addr" column="HOME_ADDR" />
		<result property="user_pwd" column="USER_PWD" />
		<result property="car_no" column="CAR_NO" />
	</resultMap>
	<resultMap type="com.jsumt.vo.system.ProjectBean" id="projectBean">
		<id property="projectId" column="PROJECT_ID" />
		<result property="projectPId" column="PROJECT_PID" />
		<result property="projectName" column="PROJECT_NAME" />
		<result property="linkMan" column="LINK_MAN" />
		<result property="remark" column="REMARK" />
		<result property="projectCode" column="PROJECT_CODE" />
		<result property="projectUnit" column="PROJECT_UNIT" />
		<result property="isLeaf" column="IS_LEAF" />
		<result property="projectLayer" column="PROJECT_LAYER" />
		<result property="projectNo" column="PROJECT_NO" />
		<result property="linkTel" column="LINK_TEL" />
		<result property="iconCls" column="ICONCLS" />
	</resultMap>
	
	
	<!-- 批量插入项目用户数据   Parameter 'userId' not found. Available parameters are [list]  -->
	<insert id="distributeUserInProject" parameterType="java.util.List">
		insert into T_SYS_PROJECTUSER
		(ID,PROJECT_ID,USER_ID)
		values
		<foreach collection="list" item="projectUser" index="index"
			separator=",">
			(
			#{projectUser.id},#{projectUser.projectId},#{projectUser.userId}
			)
		</foreach>
	</insert>

	<!-- 根据条件查询用户（没有关联项目的用户） -->
	<select id="qUserNotInProject" resultMap="userManger"
		parameterType="java.util.Map">
		SELECT t.*
		from T_SYS_USERS t
		<where>
			 NOT EXISTS (
			select u.*
			from T_SYS_USERS u inner join
			T_SYS_PROJECTUSER ro
			on u.USER_ID=ro.USER_ID
			inner join T_SYS_PROJECT r
			on
			ro.PROJECT_ID =r.PROJECT_ID
			<where>
			   u.USER_ID=t.USER_ID
				<if test="projectId != null and projectId != '' ">
					AND r.PROJECT_ID =#{projectId}
				</if>
			</where>
			)
			<if test="userName != null and userName != '' ">
				AND t.USER_NAME like CONCAT('%',#{userName},'%')
			</if>
			<if test="userCode != null and userCode != '' ">
				AND t.USER_CODE like CONCAT('%',#{userCode},'%')
			</if>

		</where>

	</select>

	<!-- 删除某项目下的用户 -->
	<delete id="delUserInProject" parameterType="java.util.Map">
		DELETE FROM
		T_SYS_PROJECTUSER WHERE USER_ID=#{userId} AND PROJECT_ID=#{projectId}
	</delete>

	<!-- 根据条件查询用户（关联项目） -->
	<select id="queryUserByProject" resultMap="userManger"
		parameterType="java.util.Map">
		select u.*
		from T_SYS_USERS u inner join T_SYS_PROJECTUSER ro
		on
		u.USER_ID=ro.USER_ID
		inner join T_SYS_PROJECT r
		on ro.PROJECT_ID =r.PROJECT_ID
		<where>
			<if test="projectId != null and projectId != '' ">
				AND r.PROJECT_ID =#{projectId}
			</if>
			<if test="userName != null and userName != '' ">
				AND u.USER_NAME like CONCAT('%',#{userName},'%')
			</if>
			<if test="userCode != null and userCode != '' ">
				AND u.USER_CODE like CONCAT('%',#{userCode},'%')
			</if>
		</where>
	</select>
	
	<!-- 根据project_id删除PROJECTUSER -->
	<delete id="deleteURByProjectId" parameterType="java.util.List">
		DELETE FROM T_SYS_PROJECTUSER
		<where>
			PROJECT_ID IN
			<foreach collection="list" item="id" open="(" close=")"
				separator=",">
				#{id}
			</foreach>
		</where>
	</delete>
	
	<!-- 根据条件查询项目（关联用户） -->
	<select id="queryProjectByUser" resultMap="projectBean"
		parameterType="com.jsumt.vo.system.UserBean">
		select r.*
		from T_SYS_USERS u inner join T_SYS_PROJECTUSER ro
		on
		u.USER_ID=ro.USER_ID
		inner join T_SYS_PROJECT r
		on ro.PROJECT_ID =r.PROJECT_ID
		<where>
			<if test="user_id != null and user_id != '' ">
				AND u.USER_ID = #{user_id}
			</if>
			<if test="user_name != null and user_name != '' ">
				AND u.USER_NAME = #{user_name}
			</if>
			<if test="user_code != null and user_code != '' ">
				AND u.USER_CODE = #{user_code}
			</if>
		</where>
	</select>

</mapper>